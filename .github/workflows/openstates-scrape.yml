name: OpenStates Scrape for wv

on:
  # schedule:
  #   - cron: "50 23 * * *"  # Daily at 23:50 UTC (~5:50 PM CST)
  # ‚ö†Ô∏è Schedule disabled while setting up files workflow
  workflow_dispatch:
    inputs:
      force-update:
        type: boolean
        description: "Force push even if upstream changed (use with caution)"
        default: false

env:
  STATE_CODE: wv
  FILES_REPO: chn-openstates-files/wv-legislation

jobs:
  scrape:
    name: "üï∑Ô∏è Scrape Data"
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      scrape-artifact-name: ${{ steps.scrape.outputs.scrape-artifact-name }}
      scrape-tarball-path: ${{ steps.scrape.outputs.scrape-tarball-path }}
      manifest-path: ${{ steps.scrape.outputs.manifest-path }}

    steps:
      - name: Checkout state repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run scraper action
        id: scrape
        uses: windy-civi/toolkit/actions/scrape@feat/decouple-format-from-scrape
        with:
          state: ${{ env.STATE_CODE }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          commit-and-push: true
          force-update: ${{ inputs.force-update }}
          branch: main

      - name: Trigger files repo to format data
        if: success()
        run: |
          echo "üöÄ Triggering format workflow in ${{ env.FILES_REPO }}..."
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ env.FILES_REPO }}/dispatches \
            -f event_type='scrape-complete' \
            -F client_payload='{"state":"${{ env.STATE_CODE }}","triggered_by":"${{ github.repository }}"}'
          echo "‚úÖ Triggered format workflow"
        env:
          GH_TOKEN: ${{ secrets.DISPATCH_TOKEN }}
